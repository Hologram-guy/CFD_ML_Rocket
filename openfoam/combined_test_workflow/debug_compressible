#!/bin/bash

# --- CONFIGURATION ---
CORES=4
CONTROL_DICT="system/controlDict"
# We must use the UPWIND schemes we created earlier to survive the vacuum
SCHEMES="system/fvSchemes" 
SCHEMES_COMP="system/fvSchemes.compressible"

# --- CLEANUP ---
rm -rf 0
rm -rf saved_stages saved_forces processor*
mkdir -p saved_stages saved_forces

# --- STEP 1: RESTORE YOUR ORIGINAL FILES (The ones that worked!) ---
echo "Restoring 0/ from 0.orig..."
cp -r 0.orig 0

# --- STEP 2: SURGICAL EDIT OF INITIAL CONDITIONS ---
# Instead of deleting the files, we edit the "internalField" line only.
# This keeps your boundary names (inlet, outlet, wall_rocket, etc.) safe.

echo "Applying Cold Start (Surgical Edit)..."

# 1. PRESSURE: Find 'internalField' and force it to 101325
# Matches "internalField   uniform <number>;" and replaces with 101325
sed -i 's/internalField.*uniform.*;/internalField   uniform 101325;/g' 0/p

# 2. TEMPERATURE: Force to 300 K
sed -i 's/internalField.*uniform.*;/internalField   uniform 300;/g' 0/T

# 3. VELOCITY: Force Internal to (0 0 0) - The "Cold Start"
# This prevents the initial shock from crashing the solver
sed -i 's/internalField.*uniform.*;/internalField   uniform (0 0 0);/g' 0/U

echo ">> Internal fields updated. Boundary names preserved."

# --- STEP 3: FORCE STABLE SETTINGS ---

# 1. Use the Upwind Schemes (Fixes the Vacuum Crash)
# Ensure you have the 'Upwind' version of fvSchemes.compressible we made earlier
if [ -f "$SCHEMES_COMP" ]; then
    cp $SCHEMES_COMP $SCHEMES
else
    echo "Warning: Stable schemes file not found. Using default."
fi

# 2. Force Low Courant Number (Fixes the Time Step)
# We use foamDictionary to safely edit controlDict
foamDictionary $CONTROL_DICT -entry startFrom -set startTime
foamDictionary $CONTROL_DICT -entry startTime -set 0
foamDictionary $CONTROL_DICT -entry endTime -set 0.015
foamDictionary $CONTROL_DICT -entry adjustTimeStep -set yes
foamDictionary $CONTROL_DICT -entry maxCo -set 0.05  # <--- CRITICAL FOR STABILITY
foamDictionary $CONTROL_DICT -entry deltaT -set 1e-8 # Start tiny

# --- STEP 4: RUN ---
echo "Decomposing..."
decomposePar > log.decomposePar

echo "Running rhoCentralFoam..."
mpirun -np $CORES rhoCentralFoam -parallel > log.rhoCentralFoam

echo "Run complete. Check log.rhoCentralFoam"